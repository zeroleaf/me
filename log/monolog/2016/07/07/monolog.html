<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Monolog</title>
  <meta name="description" content="Monolog 是 PHP 的一个日志库.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="zeroleaf.com/log/monolog/2016/07/07/monolog.html">
  <link rel="alternate" type="application/rss+xml" title="zeroleaf" href="zeroleaf.com/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">zeroleaf</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Monolog</h1>
    <p class="post-meta"><time datetime="2016-07-07T19:12:58+08:00" itemprop="datePublished">Jul 7, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Monolog 是 PHP 的一个日志库.</p>

<h2 id="section">安装</h2>

<p>可通过 composer 安装:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>composer require monolog/monolog
</code></pre>
</div>

<h2 id="section-1">核心概念</h2>

<p>每个 <code class="highlighter-rouge">Logger</code> 实例都有一个 channel(名称) 和一系列的 handler. 当添加记录到日志中时, 
可以被所有的 handler 处理. 但每个 handler 都可以决定其是否完全处理了该记录,
如果是, 则不会被之后的 handler 处理. 该部分的逻辑见 <code class="highlighter-rouge">Monolog\Logger</code>:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>/**
 * Adds a log record.
 *
 * @param  int     $level   The logging level
 * @param  string  $message The log message
 * @param  array   $context The log context
 * @return Boolean Whether the record has been processed
 */
public function addRecord($level, $message, array $context = array())
{
    // ...

    while ($handler = current($this-&gt;handlers)) {
        if (true === $handler-&gt;handle($record)) {
            break;
        }

        next($this-&gt;handlers);
    }

    // ...
}
</code></pre>
</div>

<p>每个 handler 都实现了 <code class="highlighter-rouge">Monolog\Handler\HandlerInterface</code> 接口, 一般来说,
是否传播记录是通过 <code class="highlighter-rouge">$bubble</code> 属性来控制的, 默认为 <code class="highlighter-rouge">true</code>, 说明传播.</p>

<p>每个 handler 都包含有一个 <code class="highlighter-rouge">Monolog\Formatter\FormatterInterface</code>, 决定了日志的格式.
每个 handler 也可以包含有 <code class="highlighter-rouge">processors</code>, 用于在记录日志时对记录进行处理.</p>

<h2 id="section-2">日志级别</h2>

<p>Monolog 支持 <a href="http://tools.ietf.org/html/rfc5424">RFC 5424</a> 中定义的日志级别:</p>

<ul>
  <li><code class="highlighter-rouge">DEBUG (100)</code>: 详细的 debug 信息</li>
  <li><code class="highlighter-rouge">INFO (200)</code>: 令人感兴趣的事件. 如用户登录, SQL 日志等</li>
  <li><code class="highlighter-rouge">NOTICE (250)</code>: 普通但有意义的事件</li>
  <li><code class="highlighter-rouge">WARNING (300)</code>: 异常但并不是错误. 如使用废弃的 API, 令人不快的事物但又不是错误</li>
  <li><code class="highlighter-rouge">ERROR (400)</code>: 运行时异常, 不需要立即的措施但通常需要记录与监控</li>
  <li><code class="highlighter-rouge">CRITICAL (500)</code>: 批判性的条件 (Critical conditions). 如应用组件不可用, 未预期的异常</li>
  <li><code class="highlighter-rouge">ALERT (550)</code>: 需要立即采取措施行动的. 如整个网站停止, 数据库不可用等. 这应用触发短信立即通知.</li>
  <li><code class="highlighter-rouge">EMERGENCY (600)</code>: 紧急情况, 系统不可用</li>
</ul>

<h2 id="section-3">配置</h2>

<p>一个示例如下:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Monolog\Logger</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Monolog\Handler\StreamHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Monolog\Handler\FirePHPHandler</span><span class="p">;</span>

<span class="c1">// Create the logger
</span><span class="nv">$logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">(</span><span class="s1">'my_logger'</span><span class="p">);</span>
<span class="c1">// Now add some handlers
</span><span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">StreamHandler</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s1">'/my_app.log'</span><span class="p">,</span> <span class="nx">Logger</span><span class="o">::</span><span class="na">DEBUG</span><span class="p">));</span>
<span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">FirePHPHandler</span><span class="p">());</span>

<span class="c1">// You can now use your logger
</span><span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">addInfo</span><span class="p">(</span><span class="s1">'My logger is now ready'</span><span class="p">);</span>
</code></pre>
</div>

<p>值得注意的是, 后 push 的 handler 最先处理记录, 因此 FirePHPHandler 优先处理.
这通常在临时添加禁止 bubble 的 handler 是很有用.</p>

<h2 id="section-4">记录中添加额外的数据</h2>

<p>Monolog 提供了 2 种不同的方式来添加附加信息.</p>

<h3 id="logging-context">使用 logging context</h3>

<p>日志记录方法的第二个参数 <code class="highlighter-rouge">$context</code>, 通过这个数组, 可以附加额外的信息.</p>

<p>如:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">addInfo</span><span class="p">(</span><span class="s1">'Adding a new user'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'Seldaek'</span><span class="p">));</span>
</code></pre>
</div>

<h3 id="processor">使用 Processor</h3>

<p>第二种附加额外数据的方式是使用 Processor, 相比 context, 其是对所有的记录有效的.
Processor 可以是任意的 callable, 他们会接收到 record 作为参数(一个数组),
在 callable 中可以改变 record 中的 ertra 字段, 同时在最后返回该 record. 如:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">pushProcessor</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$record</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$record</span><span class="p">[</span><span class="s1">'extra'</span><span class="p">][</span><span class="s1">'dummy'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Hello world!'</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$record</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>
</div>

<p>record 的格式如下:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>$record = array(
    'message' =&gt; (string) $message,
    'context' =&gt; $context,
    'level' =&gt; $level,
    'level_name' =&gt; $levelName,
    'channel' =&gt; $this-&gt;name,
    'datetime' =&gt; $ts,
    'extra' =&gt; array(),
);
</code></pre>
</div>

<h2 id="leveraging-channels">Leveraging channels</h2>

<p>由于日志对象是对应 channel 的, 因此我们可以将日志记录到不同的 channel 中. 
实现日志的分类, 通常这在大项目中比较有用. 同时, 值得注意的是, handler 是可以被重用的.</p>

<h2 id="section-5">自定义日志格式</h2>

<p>示例:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>// the default date format is "Y-m-d H:i:s"
$dateFormat = "Y n j, g:i a";
// the default output format is "[%datetime%] %channel%.%level_name%: %message% %context% %extra%\n"
$output = "%datetime% &gt; %level_name% &gt; %message% %context% %extra%\n";
// finally, create a formatter
$formatter = new LineFormatter($output, $dateFormat);

// Create a handler
$stream = new StreamHandler(__DIR__.'/my_app.log', Logger::DEBUG);
$stream-&gt;setFormatter($formatter);
// bind it to a logger object
$securityLogger = new Logger('security');
$securityLogger-&gt;pushHandler($stream);
</code></pre>
</div>

<p>可见, 我们可以使用 <strong>%record_key%</strong> 来引用对应 record 中的值, 
可用的 key 见如上的 record 格式.</p>

<h2 id="handlers">Handlers</h2>

<h3 id="section-6">记录到文件和系统日志</h3>

<ul>
  <li><code class="highlighter-rouge">StreamHandler</code>: 记录日志到任意的 PHP 流</li>
  <li><code class="highlighter-rouge">RotatingFileHandler</code>: 记录日志到文件, 每天创建一个新的日志文件.
 同时也会删除比 <code class="highlighter-rouge">$maxFiles</code> 更久的日志文件. 
 更好的应该使用 <a href="http://linuxcommand.org/man_pages/logrotate8.html">logrotate</a>.</li>
  <li><code class="highlighter-rouge">SyslogHandler</code>: 记录日志到系统日志(syslog).</li>
  <li><code class="highlighter-rouge">ErrorLogHandler</code>: 记录日志到 PHP 的 <code class="highlighter-rouge">error_log</code> 函数</li>
  <li><code class="highlighter-rouge">ProcessHandler</code>: 记录日志到任意进程的 <strong>STDIN</strong>, 通过命令指定</li>
</ul>

<h3 id="section-7">发送提醒和邮件</h3>

<ul>
  <li><code class="highlighter-rouge">NativeMailerHandler</code>: 通过 PHP 的 <code class="highlighter-rouge">mail()</code> 函数发送邮件</li>
  <li><code class="highlighter-rouge">SwiftMailerHandler</code>: 通过 <strong><a href="http://swiftmailer.org/">Swfit_Mailer</a></strong> 实例来发送邮件</li>
  <li><code class="highlighter-rouge">PushoverHandler</code>: 通过 <a href="https://pushover.net://pushover.net/">Pushover</a> API 发送手机短息通知</li>
  <li><code class="highlighter-rouge">HipChatHandler</code>:</li>
  <li><code class="highlighter-rouge">FlowdockHandler</code>:</li>
  <li><code class="highlighter-rouge">SlackHandler</code>:</li>
  <li><code class="highlighter-rouge">SendGridHandler</code>:</li>
  <li><code class="highlighter-rouge">MandrillHandler</code>:</li>
  <li><code class="highlighter-rouge">FleepHookHandler</code>:</li>
  <li><code class="highlighter-rouge">IFTTTHandler</code>:</li>
</ul>

<h3 id="section-8">记录到指定的服务器和基于网络的记录</h3>

<ul>
  <li><code class="highlighter-rouge">SocketHandler</code>:</li>
  <li><code class="highlighter-rouge">AmqpHandler</code>:</li>
  <li><code class="highlighter-rouge">GelfHandler</code></li>
  <li><code class="highlighter-rouge">CubeHandler</code>:</li>
  <li><code class="highlighter-rouge">RavenHandler</code>:</li>
  <li><code class="highlighter-rouge">ZendMonitorHandler</code>:</li>
  <li><code class="highlighter-rouge">NewRelicHandler</code>:</li>
  <li><code class="highlighter-rouge">LogglyHandler</code>:</li>
  <li><code class="highlighter-rouge">RollbarHandler</code>:</li>
  <li><code class="highlighter-rouge">SyslogUdpHandler</code>:</li>
  <li><code class="highlighter-rouge">LogEntriesHandler</code>:</li>
  <li><code class="highlighter-rouge">LogmaticHandler</code>:</li>
</ul>

<h3 id="section-9">开发中的记录</h3>

<ul>
  <li><code class="highlighter-rouge">FirePHPHandler</code></li>
  <li><code class="highlighter-rouge">ChromePHPHandler</code></li>
  <li><code class="highlighter-rouge">BrowserConsoleHandler</code></li>
  <li><code class="highlighter-rouge">PHPConsoleHandler</code></li>
</ul>

<h3 id="section-10">记录到数据库</h3>

<ul>
  <li><code class="highlighter-rouge">RedisHandler</code></li>
  <li><code class="highlighter-rouge">MongoDBHandler</code></li>
  <li><code class="highlighter-rouge">CouchDBHandler</code></li>
  <li><code class="highlighter-rouge">DoctrineCouchDBHandler</code></li>
  <li><code class="highlighter-rouge">ElasticSearchHandler</code></li>
  <li><code class="highlighter-rouge">DynamoDbHandler</code></li>
</ul>

<h3 id="handler">包装/特别的 Handler</h3>

<ul>
  <li><code class="highlighter-rouge">FingersCrossedHandler</code></li>
  <li><code class="highlighter-rouge">DeduplicationHandle</code></li>
  <li><code class="highlighter-rouge">WhatFailureGroupHandler</code></li>
  <li><code class="highlighter-rouge">BufferHandler</code></li>
  <li><code class="highlighter-rouge">GroupHandler</code></li>
  <li><code class="highlighter-rouge">FilterHandler</code></li>
  <li><code class="highlighter-rouge">SamplingHandler</code></li>
  <li><code class="highlighter-rouge">NullHandler</code></li>
  <li><code class="highlighter-rouge">PsrHandler</code></li>
  <li><code class="highlighter-rouge">TestHandler</code></li>
  <li><code class="highlighter-rouge">HandlerWrapper</code></li>
</ul>

<h2 id="formatters">Formatters</h2>

<ul>
  <li><code class="highlighter-rouge">LineFormatter</code></li>
  <li><code class="highlighter-rouge">HtmlFormatter</code></li>
  <li><code class="highlighter-rouge">NormalizerFormatter</code></li>
  <li><code class="highlighter-rouge">ScalarFormatter</code></li>
  <li><code class="highlighter-rouge">JsonFormatter</code></li>
  <li><code class="highlighter-rouge">WildfireFormatter</code></li>
  <li><code class="highlighter-rouge">ChromePHPFormatter</code></li>
  <li><code class="highlighter-rouge">GelfMessageFormatter</code></li>
  <li><code class="highlighter-rouge">LogstashFormatter</code></li>
  <li><code class="highlighter-rouge">ElasticaFormatter</code></li>
  <li><code class="highlighter-rouge">LogglyFormatter</code></li>
  <li><code class="highlighter-rouge">FlowdockFormatter</code></li>
  <li><code class="highlighter-rouge">MongoDBFormatter</code></li>
  <li><code class="highlighter-rouge">LogmaticFormatter</code></li>
</ul>

<h2 id="processors">Processors</h2>

<ul>
  <li><code class="highlighter-rouge">PsrLogMessageProcessor</code></li>
  <li><code class="highlighter-rouge">IntrospectionProcessor</code></li>
  <li><code class="highlighter-rouge">WebProcessor</code></li>
  <li><code class="highlighter-rouge">MemoryUsageProcessor</code></li>
  <li><code class="highlighter-rouge">MemoryPeakUsageProcessor</code></li>
  <li><code class="highlighter-rouge">ProcessIdProcessor</code></li>
  <li><code class="highlighter-rouge">UidProcessor</code></li>
  <li><code class="highlighter-rouge">GitProcessor</code></li>
  <li><code class="highlighter-rouge">TagProcessor</code></li>
</ul>

<h2 id="section-11">参考</h2>

<ul>
  <li><a href="https://github.com/theorchard/monolog-cascade">monolog-cascade</a></li>
  <li><a href="https://github.com/Seldaek/monolog/blob/master/doc/02-handlers-formatters-processors.md">Handlers, Formatters and Processors</a></li>
</ul>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">zeroleaf</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>zeroleaf</li>
          <li><a href="mailto:zeroleaf021@gmail.com">zeroleaf021@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/zeroleaf"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">zeroleaf</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/zeroleaf021"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">zeroleaf021</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
